<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Overview ¬∑ CryoGrid.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">CryoGrid.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation/">Installation</a></li><li><a class="tocitem" href="../../quickstart/">Getting Started</a></li><li><span class="tocitem">Manual</span><ul><li class="is-active"><a class="tocitem" href>Overview</a><ul class="internal"><li><a class="tocitem" href="#Setting-up-a-model"><span>Setting up a model</span></a></li><li><a class="tocitem" href="#Defining-model-behavior"><span>Defining model behavior</span></a></li></ul></li></ul></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../api/">Index</a></li><li><a class="tocitem" href="../../api/toplevel/">Method interface</a></li><li><a class="tocitem" href="../../api/numerics/">Numerics</a></li><li><a class="tocitem" href="../../api/utils/">Utilities</a></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/heat_conduction/">Heat Conduction</a></li><li><a class="tocitem" href="../../api/hydrology/">Hydrology</a></li><li><a class="tocitem" href="../../api/soils/">Soils</a></li><li><a class="tocitem" href="../../api/seb/">Surface Energy Balance</a></li></ul></li><li><a class="tocitem" href="../../api/strat/">Stratigraphy</a></li><li><a class="tocitem" href="../../api/solvers/">Solvers</a></li><li><a class="tocitem" href="../../api/diagnostics/">Diagnostics</a></li><li><a class="tocitem" href="../../api/presets/">Presets</a></li></ul></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Overview</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Overview</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CryoGrid/CryoGrid.jl/blob/master/docs/src/manual/overview.md" title="Edit on GitHub"><span class="docs-icon fab">ÔÇõ</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h1><h2 id="Setting-up-a-model"><a class="docs-heading-anchor" href="#Setting-up-a-model">Setting up a model</a><a id="Setting-up-a-model-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-a-model" title="Permalink"></a></h2><p>At the highest level, a model in <code>CryoGrid.jl</code> is defined by a <a href="../../api/numerics/#CryoGrid.Numerics.Grid"><code>Grid</code></a> and a <a href="../../api/strat/#CryoGrid.Strat.Stratigraphy"><code>Stratigraphy</code></a>, constructed top-down from individual <a href="../../api/toplevel/#CryoGrid.Layer"><code>Layer</code></a>s, each of which has one or more <a href="../../api/toplevel/#CryoGrid.Process"><code>Process</code></a>es. Each layer in the <code>Stratigraphy</code> is assigned a depth, which then aligns it with the <code>Grid</code>. All models must consist of at least three layers/nodes: <code>Top</code> and <code>Bottom</code> layers with corresponding boundary conditions, as well as one or more <a href="../../api/toplevel/#CryoGrid.SubSurface"><code>SubSurface</code></a> layers. Here we define a simple three-layer model (or one-layer, exlcuding the boundaries) with a single sub-surface process, i.e. <a href="../../api/heat_conduction/#CryoGrid.Physics.Heat.HeatBalance"><code>HeatBalance</code></a> (heat conduction):</p><pre><code class="language-julia hljs"># ... load forcings, set up profiles, etc.
# see examples/heat_vgfc_seb_saoylov_custom.jl for more details
strat = Stratigraphy(
    -2.0u&quot;m&quot; =&gt; Top(SurfaceEnergyBalance(Tair,pr,q,wind,Lin,Sin,z)),
    0.0u&quot;m&quot; =&gt; Soil(soilprofile, HeatBalance(:H;freezecurve=SFCC(DallAmico()))),
    1000.0u&quot;m&quot; =&gt; Bottom(GeothermalHeatFlux(0.053u&quot;J/s/m^2&quot;))
);
grid = CryoGrid.Presets.DefaultGrid_5cm
# define initial conditions for temperature using a given profile;
# The default initializer linearly interpolates between profile points.
initT = initializer(:T, tempprofile)
tile = Tile(strat, grid, initT);</code></pre><p>This model can then be used to construct an <code>ODEProblem</code> (from <code>DiffEqBase.jl</code>) via the <code>CryoGridProblem</code> constructor:</p><pre><code class="language-julia hljs">tspan = (DateTime(2010,10,30),DateTime(2011,10,30))
p = parameters(tile)
u0 = initialcondition!(tile, tspan, p, initT)
prob = CryoGridProblem(tile, u0, tspan, p, savevars=(:T,)) # produces an ODEProblem with problem type CryoGridODEProblem</code></pre><p>It can then be solved simply using the <code>solve</code> function (also from <code>DiffEqBase</code> and <code>OrdinaryDiffEq</code>):</p><pre><code class="language-julia hljs"># solve with forward Euler (fixed 5 minute time steps) and construct CryoGridOutput from solution
out = @time solve(prob, Euler(), dt=5*60.0, saveat=24*3600.0, progress=true) |&gt; CryoGridOutput;</code></pre><p>The result is a <code>CryoGridOutput</code> type which provides <code>DimArray</code>s containing the model outputs over time and space:</p><pre><code class="language-raw hljs">julia&gt; out.T
278√ó366 DimArray{Float64,2} with dimensions: 
  Z: Quantity{Float64, ùêã, Unitful.FreeUnits{(m,), ùêã, nothing}}[0.01 m, 0.03 m, ‚Ä¶, 850.0 m, 950.0 m] Sampled: Ordered Irregular Points,
  Ti (Time): DateTime[2010-10-30T00:00:00, ‚Ä¶, 2011-10-30T00:00:00] Sampled: Ordered Irregular Points</code></pre><h2 id="Defining-model-behavior"><a class="docs-heading-anchor" href="#Defining-model-behavior">Defining model behavior</a><a id="Defining-model-behavior-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-model-behavior" title="Permalink"></a></h2><p>Notice that, in the example above, it is types such as <code>Soil</code>, <code>HeatBalance</code>, <code>SFCC</code>, etc. that specify which components the model should use. These components are defined by adding method dispatches to the <a href="../../api/toplevel/#toplevel">core model API</a> methods. State variables are declared via the <a href="../../api/toplevel/#CryoGrid.variables-Tuple{Layer, Process}"><code>variables</code></a> method, e.g:</p><pre><code class="language-julia hljs">&quot;&quot;&quot; Variable definitions for heat conduction (enthalpy) on soil layer. &quot;&quot;&quot;
variables(soil::Soil, heat::HeatBalance{:H}) = (
    Prognostic(:H, OnGrid(Cells), u&quot;J/m^3&quot;),
    Diagnostic(:T, OnGrid(Cells), u&quot;¬∞C&quot;),
    Diagnostic(:C, OnGrid(Cells), u&quot;J//K*/m^3&quot;),
    Diagnostic(:‚àÇH‚àÇT, OnGrid(Cells), u&quot;J/K/m^3&quot;),
    Diagnostic(:k, OnGrid(Edges), u&quot;W/m/K&quot;),
    Diagnostic(:kc, OnGrid(Cells), u&quot;W//m/K&quot;),
    # this last line just appends any state variables or parameters
    # defined by the freeze curve to the tuple.
    variables(soil, heat, freezecurve(heat))...,
)</code></pre><p>When the <code>HeatBalance</code> process is assigned to a <code>Soil</code> layer, <code>Tile</code> will invoke this method and create state variables corresponding to each <a href="manual/@ref"><code>Var</code></a>. <a href="manual/@ref"><code>Prognostic</code></a> variables are assigned derivatives (in this case, <code>‚àÇH‚àÇt</code>, since <code>H</code> is the prognostic state variable) and integrated over time. <code>Diagnostic</code> variables provide in-place caches for intermediary variables/computations and can be automatically tracked by the modeling engine.</p><p>Each variable definition consists of a name (a Julia <code>Symbol</code>), a type, and a shape. For variables discretized on the grid, the shape is specified by <code>OnGrid</code>, which will generate an array of the appropriate size when the model is compiled. The arguments <code>Cells</code> and <code>Edges</code> specify whether the variable should be defined on the grid cells or edges respecitvely.</p><p>The real work finally happens in <a href="../../api/toplevel/#CryoGrid.diagnosticstep!-Tuple{Layer, Any}"><code>diagnosticstep!</code></a> and <a href="../../api/toplevel/#CryoGrid.prognosticstep!-Tuple{Layer, Any}"><code>prognosticstep!</code></a>, the latter of which should be used to compute the time derivatives (here <code>‚àÇH‚àÇt</code>). <a href="../../api/toplevel/#CryoGrid.interact!-Tuple{Layer, Layer, Any, Any}"><code>interact!</code></a> defines the behavior at the boundaries and should be used to compute the derivatives (and any other necessary values) at the interface between layers.</p><p>We can take as an example the implementation of <code>prognosticstep!</code> for enthalpy-based heat conduction (note that <code>jH</code> is a diagnostic variable representing the energy flux over each cell edge):</p><pre><code class="language-julia hljs">function CryoGrid.prognosticstep!(::SubSurface, ::HeatBalance{&lt;:FreezeCurve,&lt;:Enthalpy}, state)
    Œîk = Œî(state.grids.k) # cell sizes
    ŒîT = Œî(state.grids.T) # midpoint distances
    # compute internal fluxes and non-linear diffusion assuming boundary fluxes have been set
    nonlineardiffusion!(state.‚àÇH‚àÇt, state.jH, state.T, ŒîT, state.k, Œîk)
    return nothing
end</code></pre><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Prognostic state variables like <code>H</code> in the example above <strong>should not be directly modified</strong> in user code. This is especially important when using higher order or implicit integrators as unexpected changes to prognostic state may destroy the accuracy of their internal interpolant. For modeling discontinuities, use <a href="manual/@ref"><code>Events</code></a> instead.</p></div></div><p>Note that <code>state</code> is of type <a href="../../api/strat/#CryoGrid.Strat.LayerState"><code>LayerState</code></a> with fields corresponding to the variables declared by the <code>variables</code> function for <code>Soil</code> and <code>HeatBalance</code>. Additionally, output arrays for the time derivatives are provided (here <code>‚àÇH‚àÇt</code>), as well as the current timestep, layer boundary depths, and variable grids (accessible via <code>state.t</code>, <code>state.bounds</code>, and <code>state.grids</code> respectively). Note that <code>state</code> will also contain other variables declared on this <code>Soil</code> layer by other <code>SubSurfaceProcess</code>es, allowing for implicit coupling between processes where appropriate.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../quickstart/">¬´ Getting Started</a><a class="docs-footer-nextpage" href="../../api/">Index ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Tuesday 3 January 2023 15:31">Tuesday 3 January 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
